<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamStream AI - Smart Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            background-color: #0f172a;
            color: #e2e8f0;
            background-image: radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.1) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #38bdf8 0%, #c084fc 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .custom-loader {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            position: relative;
            animation: rotate 1s linear infinite;
        }
        
        .custom-loader::before {
            content: "";
            box-sizing: border-box;
            position: absolute;
            inset: 0px;
            border-radius: 50%;
            border: 5px solid #FFF;
            animation: prixClipFix 2s linear infinite;
        }
        
        @keyframes rotate {
            100% {
                transform: rotate(360deg)
            }
        }
        
        @keyframes prixClipFix {
            0% {
                clip-path: polygon(50% 50%, 0 0, 0 0, 0 0, 0 0, 0 0)
            }
            25% {
                clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 0, 100% 0, 100% 0)
            }
            50% {
                clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 100% 100%, 100% 100%)
            }
            75% {
                clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 0 100%, 0 100%)
            }
            100% {
                clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 0 100%, 0 0)
            }
        }
        /* Fixed canvas area height */
        
        #canvasArea {
            min-height: 600px;
        }
        
        @media (min-width: 1024px) {
            #canvasArea {
                min-height: 700px;
            }
        }
        
         ::-webkit-scrollbar {
            width: 6px;
        }
        
         ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        
         ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        
         ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="w-full p-5 border-b border-slate-800/60 bg-slate-900/80 sticky top-0 z-50 backdrop-blur-md">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                    <i class="fa-solid fa-wand-magic-sparkles text-white text-lg"></i>
                </div>
                <h1 class="text-2xl font-bold tracking-tight">AI Image Generator</h1>
            </div>
            <div class="hidden sm:flex items-center gap-4 text-sm font-medium text-slate-400">
                <span class="px-3 py-1 rounded-full bg-slate-800 border border-slate-700">
                    <i class="fa-brands fa-google mr-2"></i>Powered by Gemini & Pollinations
                </span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-8 max-w-7xl">

        <!-- Left Column: Controls -->
        <div class="w-full lg:w-[400px] flex flex-col gap-6">

            <!-- Control Panel -->
            <div class="glass-panel p-6 rounded-2xl flex flex-col gap-5">

                <!-- Prompt Input -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-sm font-semibold text-slate-300">Describe your imagination</label>
                        <button id="randomPromptBtn" class="text-xs text-indigo-400 hover:text-indigo-300 transition-colors flex items-center gap-1">
                            <i class="fa-solid fa-dice"></i> Surprise Me
                        </button>
                    </div>
                    <div class="relative group">
                        <textarea id="promptInput" rows="5" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl p-4 text-slate-200 placeholder-slate-500 focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 transition-all resize-none outline-none text-sm leading-relaxed"
                            placeholder="A futuristic city with neon lights in the rain..."></textarea>

                        <!-- Enhance Button (Floating) -->
                        <button id="enhanceBtn" class="absolute bottom-3 right-3 bg-indigo-600/20 hover:bg-indigo-600/40 text-indigo-300 border border-indigo-500/30 px-3 py-1.5 rounded-lg text-xs font-medium transition-all flex items-center gap-2 backdrop-blur-sm group-focus-within:opacity-100 opacity-80">
                            <i class="fa-solid fa-sparkles"></i> Enhance
                        </button>
                    </div>
                </div>

                <!-- Settings Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="text-xs font-medium text-slate-400">Art Style</label>
                        <div class="relative">
                            <i class="fa-solid fa-palette absolute left-3 top-3 text-slate-500 text-xs"></i>
                            <select id="styleSelect" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-lg py-2.5 pl-8 pr-3 text-sm text-slate-300 focus:ring-1 focus:ring-indigo-500 outline-none appearance-none cursor-pointer hover:bg-slate-900 transition-colors">
                                <option value="">No Filter</option>
                                <option value="photorealistic">Photorealistic</option>
                                <option value="anime">Anime / Manga</option>
                                <option value="digital art">Digital Art</option>
                                <option value="oil painting">Oil Painting</option>
                                <option value="cyberpunk">Cyberpunk</option>
                                <option value="3d render">3D Render</option>
                                <option value="watercolor">Watercolor</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-medium text-slate-400">Aspect Ratio</label>
                        <div class="relative">
                            <i class="fa-solid fa-crop-simple absolute left-3 top-3 text-slate-500 text-xs"></i>
                            <select id="ratioSelect" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-lg py-2.5 pl-8 pr-3 text-sm text-slate-300 focus:ring-1 focus:ring-indigo-500 outline-none appearance-none cursor-pointer hover:bg-slate-900 transition-colors">
                                <option value="1:1">Square (1:1)</option>
                                <option value="16:9">Landscape (16:9)</option>
                                <option value="9:16">Portrait (9:16)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <button id="generateBtn" class="w-full mt-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg shadow-indigo-500/25 transform transition-all active:scale-[0.98] flex justify-center items-center gap-2 group">
                    <span class="group-hover:tracking-wider transition-all">Generate Masterpiece</span>
                    <i class="fa-solid fa-rocket group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>

            <!-- Enhanced Prompt Display (Hidden initially) -->
            <div id="enhancedPromptBox" class="hidden glass-panel p-4 rounded-xl border-l-4 border-indigo-500">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-bold text-indigo-400 uppercase tracking-wider">AI Enhanced Prompt</span>
                    <button id="copyPromptBtn" class="text-slate-400 hover:text-white transition-colors" title="Copy to clipboard">
                        <i class="fa-regular fa-copy"></i>
                    </button>
                </div>
                <p id="enhancedPromptText" class="text-sm text-slate-300 italic leading-relaxed"></p>
            </div>

            <!-- History -->
            <div class="glass-panel rounded-2xl flex-1 flex flex-col overflow-hidden min-h-[200px]">
                <div class="p-4 border-b border-slate-700/50">
                    <h3 class="text-sm font-semibold text-slate-300 flex items-center gap-2">
                        <i class="fa-solid fa-clock-rotate-left text-indigo-400"></i> Recent Creations
                    </h3>
                </div>
                <div id="historyContainer" class="p-4 space-y-3 overflow-y-auto max-h-[300px]">
                    <div class="text-center text-slate-500 text-xs py-8">Your generated images will appear here</div>
                </div>
            </div>
        </div>

        <!-- Right Column: Preview Stage -->
        <div class="w-full lg:flex-1">
            <div class="glass-panel p-2 rounded-2xl relative shadow-2xl overflow-hidden flex flex-col">

                <!-- Main Canvas -->
                <div id="canvasArea" class="relative w-full bg-slate-950 rounded-xl overflow-hidden flex items-center justify-center bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center p-8 max-w-md">
                        <div class="w-20 h-20 bg-slate-800/50 rounded-2xl mx-auto mb-6 flex items-center justify-center border border-slate-700/50 rotate-3 transform transition-transform hover:rotate-0">
                            <i class="fa-regular fa-image text-3xl text-slate-600"></i>
                        </div>
                        <h2 class="text-xl font-bold text-slate-200 mb-2">Ready to Create?</h2>
                        <p class="text-slate-500 text-sm">Enter a prompt or use the "Enhance" feature to let our AI write the prompt for you.</p>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="hidden absolute inset-0 bg-slate-900/90 z-20 flex flex-col items-center justify-center backdrop-blur-sm">
                        <div class="custom-loader mb-6"></div>
                        <h3 class="text-lg font-medium text-white mb-1" id="loadingText">Generating Art...</h3>
                        <p class="text-slate-400 text-sm animate-pulse">This usually takes about 5-15 seconds</p>
                    </div>

                    <!-- Error State -->
                    <div id="errorState" class="hidden absolute inset-0 bg-slate-900/95 z-20 flex flex-col items-center justify-center p-8 text-center">
                        <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mb-4">
                            <i class="fa-solid fa-triangle-exclamation text-red-500 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-white mb-2">Generation Failed</h3>
                        <p id="errorMessage" class="text-slate-400 text-sm mb-6 max-w-xs">Something went wrong.</p>
                        <button onclick="document.getElementById('errorState').classList.add('hidden')" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-white transition-colors">Dismiss</button>
                    </div>

                    <!-- Result Image -->
                    <img id="resultImage" class="hidden w-full h-full object-contain shadow-2xl transition-all duration-700" alt="Generated AI Art">
                </div>

                <!-- Action Bar (Appears when image exists) -->
                <div id="actionBar" class="hidden p-4 bg-slate-900/50 border-t border-slate-700/50 flex justify-between items-center">
                    <div class="text-xs text-slate-400">
                        Generated by <span class="text-indigo-400 font-medium">Pollinations AI</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="downloadBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-lg shadow-indigo-500/20">
                            <i class="fa-solid fa-download"></i> Download
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // ============================================
        // BACKEND API CONFIGURATION
        // ============================================
        const API_BASE_URL = '/api';

        // --- State Management ---
        const state = {
            isGenerating: false,
            isEnhancing: false,
            currentImageBlob: null,
            history: []
        };

        // --- DOM Elements ---
        const els = {
            promptInput: document.getElementById('promptInput'),
            styleSelect: document.getElementById('styleSelect'),
            ratioSelect: document.getElementById('ratioSelect'),
            generateBtn: document.getElementById('generateBtn'),
            enhanceBtn: document.getElementById('enhanceBtn'),
            resultImage: document.getElementById('resultImage'),
            emptyState: document.getElementById('emptyState'),
            loadingState: document.getElementById('loadingState'),
            loadingText: document.getElementById('loadingText'),
            errorState: document.getElementById('errorState'),
            errorMessage: document.getElementById('errorMessage'),
            actionBar: document.getElementById('actionBar'),
            downloadBtn: document.getElementById('downloadBtn'),
            enhancedPromptBox: document.getElementById('enhancedPromptBox'),
            enhancedPromptText: document.getElementById('enhancedPromptText'),
            randomPromptBtn: document.getElementById('randomPromptBtn'),
            historyContainer: document.getElementById('historyContainer')
        };

        // --- Helper: Random Prompts ---
        const randomPrompts = [
            "A small cabin on top of a snowy mountain at sunset",
            "A cyberpunk street food vendor serving neon noodles",
            "A cute robot gardening on Mars, pixar style",
            "An underwater city made of glass bubbles, bioluminescent",
            "Portrait of a cat dressed as a renaissance king, oil painting"
        ];

        // ============================================
        // BACKEND API FUNCTIONS
        // ============================================

        async function callTextAPI(prompt) {
            try {
                const response = await fetch(`${API_BASE_URL}/enhance-prompt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to enhance prompt');
                }

                return data.enhanced_prompt;
            } catch (error) {
                console.error("Enhance API Error:", error);
                throw error;
            }
        }

        async function callImageAPI(prompt, style = '') {
            try {
                const response = await fetch(`${API_BASE_URL}/generate-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt,
                        style
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to generate image');
                }

                return data.image;
            } catch (error) {
                console.error("Image API Error:", error);
                throw error;
            }
        }

        // ============================================
        // CORE LOGIC
        // ============================================

        async function enhancePrompt() {
            if (state.isEnhancing) return;

            const originalText = els.promptInput.value.trim();
            if (!originalText) {
                showNotification("Please enter a prompt first!", "error");
                return;
            }

            state.isEnhancing = true;
            els.enhanceBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Magic...';
            els.enhanceBtn.disabled = true;

            try {
                const enhancedText = await callTextAPI(originalText);

                els.promptInput.value = enhancedText.trim();
                els.enhancedPromptBox.classList.remove('hidden');
                els.enhancedPromptText.textContent = enhancedText.trim();
                console.log("âœ… Prompt enhanced successfully!");

            } catch (error) {
                const errorMsg = error.message || "Could not enhance prompt";
                showNotification(errorMsg, "error");
                console.error("Enhance error:", errorMsg);
            } finally {
                els.enhanceBtn.innerHTML = '<i class="fa-solid fa-sparkles"></i> Enhance';
                els.enhanceBtn.disabled = false;
                state.isEnhancing = false;
            }
        }

        async function handleGenerate() {
            if (state.isGenerating) return;

            const prompt = els.promptInput.value.trim();
            if (!prompt) {
                showNotification("Please describe what you want to see!", "error");
                return;
            }

            setLoading(true);

            try {
                const style = els.styleSelect.value;

                console.log("ðŸŽ¨ Starting image generation...");

                const base64Image = await callImageAPI(prompt, style);
                const imageUrl = `data:image/png;base64,${base64Image}`;

                console.log("âœ… Image generated successfully!");

                displayImage(imageUrl);
                addToHistory(imageUrl, prompt);

                state.currentImageBlob = base64Image;

            } catch (error) {
                const errorMsg = error.message || "Failed to generate image";
                console.error("Generation error:", errorMsg);
                showError(errorMsg);
            } finally {
                setLoading(false);
            }
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================

        function setLoading(isLoading) {
            state.isGenerating = isLoading;
            if (isLoading) {
                els.generateBtn.disabled = true;
                els.generateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating...';
                els.loadingState.classList.remove('hidden');
                els.errorState.classList.add('hidden');
                els.actionBar.classList.add('hidden');
            } else {
                els.generateBtn.disabled = false;
                els.generateBtn.innerHTML = '<span class="group-hover:tracking-wider transition-all">Generate Masterpiece</span><i class="fa-solid fa-rocket group-hover:translate-x-1 transition-transform"></i>';
                els.loadingState.classList.add('hidden');
            }
        }

        function displayImage(src) {
            els.resultImage.src = src;
            els.resultImage.onload = () => {
                els.emptyState.classList.add('hidden');
                els.resultImage.classList.remove('hidden');
                els.actionBar.classList.remove('hidden');
            };
        }

        function showError(msg) {
            els.errorState.classList.remove('hidden');
            els.errorMessage.textContent = msg;
            els.emptyState.classList.add('hidden');
        }

        function addToHistory(url, prompt) {
            if (els.historyContainer.children.length > 0 && els.historyContainer.children[0].classList.contains('text-center')) {
                els.historyContainer.innerHTML = '';
            }

            const div = document.createElement('div');
            div.className = "flex gap-3 p-2 rounded-lg hover:bg-slate-800/50 cursor-pointer transition-colors group";
            div.innerHTML = `
                <img src="${url}" class="w-12 h-12 rounded-md object-cover bg-slate-900 border border-slate-700">
                <div class="flex-1 min-w-0 flex flex-col justify-center">
                    <p class="text-xs text-slate-300 truncate font-medium group-hover:text-indigo-400 transition-colors">${prompt}</p>
                    <p class="text-[10px] text-slate-500">${new Date().toLocaleTimeString()}</p>
                </div>
            `;

            div.onclick = () => {
                els.promptInput.value = prompt;
                displayImage(url);
            };

            els.historyContainer.prepend(div);
            if (els.historyContainer.children.length > 10) {
                els.historyContainer.lastChild.remove();
            }
        }

        function showNotification(msg, type = 'info') {
            if (type === 'error') {
                console.error(msg);
                alert(msg);
            } else {
                console.log(msg);
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        els.generateBtn.addEventListener('click', handleGenerate);
        els.enhanceBtn.addEventListener('click', enhancePrompt);

        els.randomPromptBtn.addEventListener('click', () => {
            const randomPrompt = randomPrompts[Math.floor(Math.random() * randomPrompts.length)];
            els.promptInput.value = randomPrompt;
            console.log("ðŸŽ² Random prompt selected");
        });

        els.downloadBtn.addEventListener('click', () => {
            if (!els.resultImage.src) return;
            const link = document.createElement('a');
            link.href = els.resultImage.src;
            link.download = `dreamstream-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            console.log("ðŸ’¾ Image downloaded");
        });

        document.getElementById('copyPromptBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(els.enhancedPromptText.textContent);
            console.log("ðŸ“‹ Prompt copied to clipboard");
        });

        els.promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!state.isGenerating) {
                    handleGenerate();
                }
            }
        });

        console.log("âœ… DreamStream AI Frontend Loaded");
        console.log("ðŸ”— Backend API:", API_BASE_URL);
    </script>
</body>

</html>